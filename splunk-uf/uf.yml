---
- hosts: uf1
  vars:
      splunkforwarderver: 6.5.1-f74036626f0c-linux-2.6-x86_64
      # ssl_enabled
      # auth_enabled

  handlers:
      - include: handlers/handlers.yml

  tasks:
    - name: Ensure libselinux-python installed
      yum: name=libselinux-python state=present

    - name: Ensure net-tools installed
      yum: name=net-tools state=present

    - name: Ensure wget installed
      yum: name=wget state=present

    - name: Ensure aliases.sh present
      copy: src=files/aliases.sh dest=/etc/profile.d/aliases.sh
            owner=root group=root mode=0644

    - name: Ensure hostname is in /etc/hosts
      lineinfile:
        dest=/etc/hosts
        regexp="^{{ ansible_default_ipv4.address }}.+$"
        line="{{ ansible_default_ipv4.address }} {{ ansible_fqdn }} {{ ansible_hostname }}"

    - name: Ensures destFolder dir exists
      file: path=/opt/splunkforwarder/ state=directory
      
    - name: Copy UF file
      copy: src={{ ansible_os_family }}/splunkforwarder-{{ splunkforwarderver }}.rpm dest=/opt/splunkforwarder/splunkforwarder-{{ splunkforwarderver }}.rpm force=no

    - name: Ensure Splunk universal forwarder package installed
      yum:  name=/opt/splunkforwarder/splunkforwarder-{{ splunkforwarderver }}.rpm state=present

    - name: Set splunk admin password
      shell: /opt/splunkforwarder/bin/splunk edit user admin -password splunk -auth admin:splunk  --accept-license

    - name: Enable forward server
      shell: /opt/splunkforwarder/bin/splunk add forward-server 192.168.33.102:9997 -auth admin:splunk

    - name: Add second forward server
      shell: /opt/splunkforwarder/bin/splunk add forward-server 192.168.33.103:9997 -auth admin:splunk

    - name: Add monitor
      shell: /opt/splunkforwarder/bin/splunk add monitor /var/log -auth admin:splunk

    - name: Enable splunk boot start
      shell: /opt/splunkforwarder/bin/splunk enable boot-start -user splunk

    - name: restart splunk forwarder
      shell: /opt/splunkforwarder/bin/splunk restart

    - name: Ensure Splunk service is configured
      copy: src=files/splunk.init dest=/etc/init.d/splunk
            owner=splunk group=splunk mode=0755
      notify:
        - restart Splunk

    - name: Change the ownership of all the splunk related directories to the splunk user 
      shell: 'chown splunk: /opt/splunkforwarder/'
    
  

